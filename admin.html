<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ“ê¸€ ê´€ë¦¬ - JEIU Creative Collection</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
            background: #ffffff;
            color: #333;
            line-height: 1.5;
            padding: 16px;
        }

        .admin-container {
            max-width: 100%;
            margin: 0 auto;
        }

        .admin-header {
            margin-bottom: 24px;
        }

        .admin-header h1 {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        .admin-header p {
            color: #666;
            font-size: 0.9rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .stat-card:nth-child(1) .stat-number { color: #0066cc; }
        .stat-card:nth-child(2) .stat-number { color: #28a745; }
        .stat-card:nth-child(3) .stat-number { color: #dc3545; }
        .stat-card:nth-child(4) .stat-number { color: #6f42c1; }

        .stat-label {
            color: #666;
            font-size: 0.8rem;
        }

        .controls-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .search-container {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 1rem;
        }

        .search-input:focus {
            outline: none;
            border-color: #0066cc;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .filter-select {
            padding: 12px 16px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: #0066cc;
        }

        .btn {
            padding: 12px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .btn-primary {
            background: #0066cc;
            color: white;
        }

        .btn-primary:hover {
            background: #0052a3;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .comments-table-container {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }

        .table-header {
            background: #f8f9fa;
            padding: 16px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1rem;
            font-weight: 600;
        }

        .table-info {
            color: #666;
            font-size: 0.9rem;
        }

        .comments-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .comments-table th {
            background: #f8f9fa;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.8rem;
        }

        .comments-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #f1f3f4;
            vertical-align: top;
        }

        .comments-table tr:hover {
            background: #f8f9fa;
        }

        .comments-table tr.deleted {
            background: #fff5f5;
            opacity: 0.7;
        }

        .checkbox-cell {
            width: 40px;
            text-align: center;
        }

        .custom-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .name-cell {
            font-weight: 600;
            min-width: 80px;
            text-align: left;
        }

        .text-cell {
            max-width: 200px;
            line-height: 1.4;
            text-align: left;
        }

        .text-preview {
            display: -webkit-box;
            display: -moz-box;
            display: box;
            -webkit-line-clamp: 2;
            -moz-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            -moz-box-orient: vertical;
            box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .meta-cell {
            font-size: 0.8rem;
            color: #666;
            min-width: 120px;
        }

        .meta-item {
            margin-bottom: 4px;
        }

        .meta-label {
            font-weight: 500;
        }

        .team-badge {
            background: #0066cc;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
        }

        .actions-cell {
            width: 80px;
            text-align: right;
        }

        .action-btn {
            padding: 6px 8px;
            border: none;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-bottom: 4px;
            display: block;
            width: 100%;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .restore-btn {
            background: #28a745;
            color: white;
        }

        .restore-btn:hover {
            background: #218838;
        }

        .deleted-badge {
            background: #dc3545;
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .loading-state, .empty-state {
            text-align: center;
            color: #666;
        }

        .empty-icon {
            font-size: 2rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) {
            body {
                padding: 8px;
            }

            .admin-header h1 {
                font-size: 1.3rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .stat-card {
                padding: 12px;
            }

            .stat-number {
                font-size: 1.5rem;
            }

            .controls-section {
                padding: 12px;
            }

            .comments-table {
                font-size: 0.8rem;
            }

            .comments-table th,
            .comments-table td {
                padding: 8px 4px;
            }

            .text-cell {
                max-width: 150px;
            }

            .meta-cell {
                min-width: 100px;
            }

            .actions-cell {
                width: 60px;
            }

            .btn {
                padding: 10px 12px;
                font-size: 0.8rem;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .comments-table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .table-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>ğŸ”§ ëŒ“ê¸€ ê´€ë¦¬</h1>
            <p>JEIU Creative Collection ëŒ“ê¸€ ê´€ë¦¬ì í˜ì´ì§€</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="total-comments">0</div>
                <div class="stat-label">ì „ì²´ ëŒ“ê¸€</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="active-comments">0</div>
                <div class="stat-label">í™œì„± ëŒ“ê¸€</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="deleted-comments">0</div>
                <div class="stat-label">ì‚­ì œëœ ëŒ“ê¸€</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="teams-count">0</div>
                <div class="stat-label">íŒ€ ìˆ˜</div>
            </div>
        </div>

        <div class="controls-section">
            <div class="controls-grid">
                <div class="search-container">
                    <span class="search-icon">ğŸ”</span>
                    <input type="text" id="search-input" class="search-input" placeholder="ì´ë¦„, ë‚´ìš©ìœ¼ë¡œ ê²€ìƒ‰...">
                </div>
                <select class="filter-select" id="status-filter">
                    <option value="all">ì „ì²´ ìƒíƒœ</option>
                    <option value="active">í™œì„±</option>
                    <option value="deleted">ì‚­ì œë¨</option>
                </select>
                <select class="filter-select" id="team-filter">
                    <option value="all">ëª¨ë“  íŒ€</option>
                </select>
                <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="toggleSelectAll()">ì „ì²´ ì„ íƒ</button>
                    <button class="btn btn-danger" onclick="bulkDeleteSelected()">ì„ íƒ ì‚­ì œ</button>
                    <button class="btn btn-warning" onclick="bulkUpdateTeamIds()">ğŸ”§ teamID ìˆ˜ì •</button>
                    <button class="btn btn-primary" onclick="verifyTeamIds()">ğŸ” ê²€ì¦</button>
                </div>
            </div>
            <div>
                <button class="btn btn-primary" onclick="refreshComments()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                <button class="btn btn-danger" onclick="bulkDelete()">ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ</button>
            </div>
        </div>

        <div class="comments-table-container">
            <div class="table-header">
                <div class="table-title">ëŒ“ê¸€ ëª©ë¡</div>
                <div class="table-info" id="table-info">ì´ 0ê°œì˜ ëŒ“ê¸€</div>
            </div>
            <div id="comments-list" class="loading-state">
                <div class="empty-icon">â³</div>
                <div>ë¡œë”© ì¤‘...</div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase ì´ˆê¸°í™”
        const firebaseConfig = {
            apiKey: "AIzaSyD7yIunudoV4htLvh7K4zSKXibRM4oquUw",
            authDomain: "dailyprincess-6c2c2.firebaseapp.com",
            databaseURL: "https://dailyprincess-6c2c2.firebaseio.com",
            projectId: "dailyprincess-6c2c2",
            storageBucket: "dailyprincess-6c2c2.firebasestorage.app",
            messagingSenderId: "953948313357",
            appId: "1:953948313357:web:80d229c82c94edc31b4244"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ì „ì—­ ë³€ìˆ˜
        let allComments = [];
        let filteredComments = [];
        let selectedComments = new Set();
        let teamData = {}; // íŒ€ ë°ì´í„° ì €ì¥

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAccess();
        });

        // ê´€ë¦¬ì ê¶Œí•œ ì²´í¬
        async function checkAdminAccess() {
            const adminKey = localStorage.getItem('adminKey');
            
            if (!adminKey) {
                showAdminLogin();
                return;
            }
            
            try {
                // Firebase Functions ëŒ€ì‹  ì§ì ‘ HTTP ìš”ì²­
                const response = await fetch('https://checkadminkey-tyxkxm7wcq-uc.a.run.app/checkAdminKey', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ data: { key: adminKey } })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.data && result.data.ok) {
                        // ê¶Œí•œ í™•ì¸ ì„±ê³µ
                        initializeAdmin();
                    } else {
                        // ê¶Œí•œ ì—†ìŒ
                        localStorage.removeItem('adminKey');
                        showAdminLogin();
                    }
                } else {
                    throw new Error('Network response was not ok');
                }
            } catch (error) {
                console.error('Admin check failed:', error);
                localStorage.removeItem('adminKey');
                showAdminLogin();
            }
        }

        // ê´€ë¦¬ì ë¡œê·¸ì¸ ì¸í„°í˜ì´ìŠ¤ í‘œì‹œ
        function showAdminLogin() {
            document.body.innerHTML = `
                <div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                    <div style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 90%;">
                        <h2 style="margin-bottom: 20px; color: #333;">ğŸ” ê´€ë¦¬ì ì ‘ê·¼</h2>
                        <p style="color: #666; margin-bottom: 30px;">ê´€ë¦¬ì í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                        <input type="password" id="admin-key-input" placeholder="ê´€ë¦¬ì í‚¤" 
                               style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 20px; font-size: 16px;">
                        <button onclick="loginAdmin()" 
                                style="background: #0066cc; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; width: 100%;">
                            ì ‘ì†
                        </button>
                        <div id="login-error" style="color: #dc3545; margin-top: 15px; display: none;">ê´€ë¦¬ì í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
                    </div>
                </div>
            `;
            
            // Enter í‚¤ë¡œ ë¡œê·¸ì¸
            document.getElementById('admin-key-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loginAdmin();
                }
            });
        }

        // ê´€ë¦¬ì ë¡œê·¸ì¸
        async function loginAdmin() {
            const key = document.getElementById('admin-key-input').value;
            const errorDiv = document.getElementById('login-error');
            
            if (!key) {
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                // Firebase Functions ëŒ€ì‹  ì§ì ‘ HTTP ìš”ì²­
                const response = await fetch('https://checkadminkey-tyxkxm7wcq-uc.a.run.app/checkAdminKey', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ data: { key: key } })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.data && result.data.ok) {
                        // ë¡œê·¸ì¸ ì„±ê³µ
                        localStorage.setItem('adminKey', key);
                        location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ê´€ë¦¬ì í˜ì´ì§€ ë¡œë“œ
                    } else {
                        errorDiv.style.display = 'block';
                    }
                } else {
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Login failed:', error);
                errorDiv.style.display = 'block';
            }
        }

        async function initializeAdmin() {
            await loadTeamData(); // íŒ€ ë°ì´í„° ë¨¼ì € ë¡œë“œ
            await loadComments();
            setupEventListeners();
            setupRealtimeListener();
        }

        // íŒ€ ë°ì´í„° ë¡œë“œ
        async function loadTeamData() {
            try {
                const res = await fetch("data.json");
                const data = await res.json();
                
                // íŒ€ ë°ì´í„°ë¥¼ IDë¥¼ í‚¤ë¡œ í•˜ëŠ” ê°ì²´ë¡œ ë³€í™˜
                teamData = {};
                ['aë°˜', 'bë°˜'].forEach(className => {
                    if (data[className]) {
                        data[className].forEach(team => {
                            teamData[team.id] = team["ì¡°ì´ë¦„"] || team.id;
                        });
                    }
                });
                
                console.log('Team data loaded:', teamData);
                
                // íŒ€ ë°ì´í„° ë¡œë“œ í›„ ëŒ“ê¸€ ë‹¤ì‹œ í‘œì‹œ
                if (allComments.length > 0) {
                    filterComments();
                }
            } catch (error) {
                console.error('Error loading team data:', error);
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            document.getElementById('search-input').addEventListener('input', filterComments);
            document.getElementById('status-filter').addEventListener('change', filterComments);
            document.getElementById('team-filter').addEventListener('change', filterComments);
        }

        // ë‚ ì§œ í¬ë§· í•¨ìˆ˜
        function formatDate(timestamp) {
            if (!timestamp) return 'ì•Œ ìˆ˜ ì—†ìŒ';
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            // 1ë¶„ ì´ë‚´: "ë°©ê¸ˆ ì „"
            if (diff < 60000) {
                return 'ë°©ê¸ˆ ì „';
            }
            
            // 1ì‹œê°„ ì´ë‚´: "Xë¶„ ì „"
            if (diff < 3600000) {
                const minutes = Math.floor(diff / 60000);
                return `${minutes}ë¶„ ì „`;
            }
            
            // 24ì‹œê°„ ì´ë‚´: "Xì‹œê°„ ì „"
            if (diff < 86400000) {
                const hours = Math.floor(diff / 3600000);
                return `${hours}ì‹œê°„ ì „`;
            }
            
            // 7ì¼ ì´ë‚´: "Xì¼ ì „"
            if (diff < 604800000) {
                const days = Math.floor(diff / 86400000);
                return `${days}ì¼ ì „`;
            }
            
            // ê·¸ ì™¸: ë‚ ì§œ í‘œì‹œ
            return date.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupRealtimeListener() {
            db.collection('comments').onSnapshot((snapshot) => {
                console.log('Comments updated in real-time');
                loadComments();
                // íŒ€ ë°ì´í„°ê°€ ë¡œë“œëœ í›„ ë‹¤ì‹œ í‘œì‹œ
                setTimeout(() => {
                    if (Object.keys(teamData).length > 0) {
                        filterComments();
                    }
                }, 100);
            }, (error) => {
                console.error('Real-time listener error:', error);
            });
        }

        async function bulkUpdateTeamIds() {
            if (!confirm('ì •ë§ë¡œ teamId ëŒ€ëŸ‰ ì—…ë°ì´íŠ¸ë¥¼ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }
            
            console.log('ğŸ”„ Starting bulk update for teamId values...');
            
            try {
                const snapshot = await db.collection('comments').get();
                console.log(`ğŸ“Š Found ${snapshot.size} comments to check`);
                
                let updateCount = 0;
                const batch = db.batch();
                
                for (const doc of snapshot.docs) {
                    const commentData = doc.data();
                    const currentTeamId = commentData.teamId;
                    
                    if (currentTeamId && currentTeamId.startsWith('team_team_')) {
                        const newTeamId = currentTeamId.replace('team_team_', 'team_');
                        
                        console.log(`ğŸ”§ Updating comment ${doc.id}:`);
                        console.log(`   Old teamId: ${currentTeamId}`);
                        console.log(`   New teamId: ${newTeamId}`);
                        
                        batch.update(doc.ref, { teamId: newTeamId });
                        updateCount++;
                        
                        if (updateCount % 500 === 0) {
                            console.log(`ğŸ“ Committing batch ${Math.floor(updateCount / 500)}...`);
                            await batch.commit();
                            batch = db.batch();
                        }
                    }
                }
                
                if (updateCount % 500 !== 0) {
                    console.log('ğŸ“ Committing final batch...');
                    await batch.commit();
                }
                
                console.log(`âœ… Bulk update completed!`);
                console.log(`ğŸ“ˆ Total comments updated: ${updateCount}`);
                
                if (updateCount === 0) {
                    alert('âœ… ìˆ˜ì •í•  teamIdê°€ ì—†ìŠµë‹ˆë‹¤. ì´ë¯¸ ì˜¬ë°”ë¥¸ ìƒíƒœì…ë‹ˆë‹¤.');
                } else {
                    alert(`âœ… ${updateCount}ê°œì˜ ëŒ“ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    // ëŒ“ê¸€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    loadComments();
                }
                
            } catch (error) {
                console.error('âŒ Bulk update failed:', error);
                alert('âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + error.message);
            }
        }
        
        async function verifyTeamIds() {
            console.log('ğŸ” Verifying updates...');
            
            try {
                const snapshot = await db.collection('comments').get();
                let incorrectCount = 0;
                let correctCount = 0;
                
                snapshot.forEach(doc => {
                    const teamId = doc.data().teamId;
                    if (teamId && teamId.startsWith('team_team_')) {
                        console.log(`âŒ Still incorrect: ${doc.id} -> ${teamId}`);
                        incorrectCount++;
                    } else if (teamId && teamId.startsWith('team_')) {
                        correctCount++;
                    }
                });
                
                console.log(`âœ… Correct teamId values: ${correctCount}`);
                console.log(`âŒ Incorrect teamId values: ${incorrectCount}`);
                
                if (incorrectCount === 0) {
                    alert('ğŸ‰ ëª¨ë“  teamIdê°€ ì˜¬ë°”ë¦…ë‹ˆë‹¤!');
                } else {
                    alert(`âš ï¸ ${incorrectCount}ê°œì˜ teamIdê°€ ì—¬ì „íˆ ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.`);
                }
                
            } catch (error) {
                console.error('âŒ Verification failed:', error);
                alert('âŒ ê²€ì¦ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ëŒ“ê¸€ ë¡œë“œ
        async function loadComments() {
            try {
                const snapshot = await db.collection('comments').get();
                allComments = [];
                const teams = new Set();

                snapshot.forEach((doc) => {
                    const comment = {
                        id: doc.id,
                        ...doc.data()
                    };
                    allComments.push(comment);
                    
                    if (comment.teamId) {
                        teams.add(comment.teamId);
                    }
                });

                // íŒ€ í•„í„° ì—…ë°ì´íŠ¸
                updateTeamFilter(teams);
                
                // í†µê³„ ì—…ë°ì´íŠ¸
                updateStats();
                
                // í•„í„°ë§ ë° í‘œì‹œ
                filterComments();
                
            } catch (error) {
                console.error('Error loading comments:', error);
                document.getElementById('comments-list').innerHTML = '<div class="empty-state"><div class="empty-icon">âŒ</div><div>ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div></div>';
            }
        }

        // íŒ€ í•„í„° ì—…ë°ì´íŠ¸
        function updateTeamFilter(teams) {
            const teamFilter = document.getElementById('team-filter');
            const currentValue = teamFilter.value;
            
            teamFilter.innerHTML = '<option value="all">ëª¨ë“  íŒ€</option>';
            
            // íŒ€ IDë¥¼ íŒ€ ì´ë¦„ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì •ë ¬
            const teamNames = [];
            Array.from(teams).forEach(teamId => {
                const teamName = teamData[teamId] || teamId;
                teamNames.push({ id: teamId, name: teamName });
            });
            
            teamNames.sort((a, b) => a.name.localeCompare(b.name, 'ko'));
            
            teamNames.forEach(team => {
                const option = document.createElement('option');
                option.value = team.id;
                option.textContent = team.name;
                teamFilter.appendChild(option);
            });
            
            // ì´ì „ ì„ íƒ ìœ ì§€
            if (currentValue && currentValue !== 'all') {
                teamFilter.value = currentValue;
            }
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            const total = allComments.length;
            const active = allComments.filter(c => !c.deleted).length;
            const deleted = allComments.filter(c => c.deleted).length;
            const teams = new Set(allComments.map(c => c.teamId)).size;

            document.getElementById('total-comments').textContent = total;
            document.getElementById('active-comments').textContent = active;
            document.getElementById('deleted-comments').textContent = deleted;
            document.getElementById('teams-count').textContent = teams;
        }

        // ëŒ“ê¸€ í•„í„°ë§
        function filterComments() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            const teamFilter = document.getElementById('team-filter').value;

            filteredComments = allComments.filter(comment => {
                // ê²€ìƒ‰ì–´ í•„í„°
                const matchesSearch = !searchTerm || 
                    comment.name?.toLowerCase().includes(searchTerm) ||
                    comment.text?.toLowerCase().includes(searchTerm);

                // ìƒíƒœ í•„í„°
                const matchesStatus = statusFilter === 'all' ||
                    (statusFilter === 'active' && !comment.deleted) ||
                    (statusFilter === 'deleted' && comment.deleted);

                // íŒ€ í•„í„°
                const matchesTeam = teamFilter === 'all' || comment.teamId === teamFilter;

                return matchesSearch && matchesStatus && matchesTeam;
            });

            displayComments();
        }

        // ëŒ“ê¸€ í‘œì‹œ
        function displayComments() {
            const container = document.getElementById('comments-list');
            const tableInfo = document.getElementById('table-info');
            
            tableInfo.textContent = `ì´ ${filteredComments.length}ê°œì˜ ëŒ“ê¸€`;
            
            if (filteredComments.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“</div><div>ì¡°ê±´ì— ë§ëŠ” ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div></div>';
                return;
            }

            // íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
            const sortedComments = filteredComments.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

            container.innerHTML = `
                <table class="comments-table">
                    <thead>
                        <tr>
                            <th class="checkbox-cell">
                                <input type="checkbox" class="custom-checkbox" id="select-all" onchange="toggleSelectAll()">
                            </th>
                            <th>ì´ë¦„</th>
                            <th>ëŒ“ê¸€ ë‚´ìš©</th>
                            <th>ë©”íƒ€ì •ë³´</th>
                            <th class="actions-cell">ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedComments.map(comment => {
                            const teamName = teamData[comment.teamId] || comment.teamId || 'ì•Œ ìˆ˜ ì—†ìŒ';
                            return `
                            <tr class="${comment.deleted ? 'deleted' : ''}" data-id="${comment.id}">
                                <td class="checkbox-cell">
                                    <input type="checkbox" class="custom-checkbox comment-checkbox" value="${comment.id}" 
                                        ${comment.deleted ? 'disabled' : ''} onchange="toggleCommentSelection('${comment.id}')">
                                </td>
                                <td class="name-cell">
                                    ${escapeHtml(comment.name || 'ìµëª…')}
                                    ${comment.deleted ? '<span class="deleted-badge">ì‚­ì œë¨</span>' : ''}
                                </td>
                                <td class="text-cell">
                                    <div class="text-preview">${escapeHtml(comment.text || '')}</div>
                                </td>
                                <td class="meta-cell">
                                    <div class="meta-item">
                                        <span class="meta-label">íŒ€:</span>
                                        <span class="team-badge">${escapeHtml(teamData[comment.teamId] || comment.teamId || 'ì•Œ ìˆ˜ ì—†ìŒ')}</span>
                                    </div>
                                    <div class="meta-item">
                                        <span class="meta-label">ì‹œê°„:</span>
                                        <span>${formatDate(comment.timestamp)}</span>
                                    </div>
                                </td>
                                <td class="actions-cell">
                                    ${!comment.deleted ? 
                                        `<button class="action-btn delete-btn" onclick="deleteComment('${comment.id}')">ì‚­ì œ</button>` :
                                        `<button class="action-btn restore-btn" onclick="restoreComment('${comment.id}')">ë³µêµ¬</button>`
                                    }
                                </td>
                            </tr>
                        `;}).join('')}
                    </tbody>
                </table>
            `;
        }

        // ì „ì²´ ì„ íƒ í† ê¸€
        function toggleSelectAll() {
            const selectAll = document.getElementById('select-all');
            const checkboxes = document.querySelectorAll('.comment-checkbox:not(:disabled)');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
                if (selectAll.checked) {
                    selectedComments.add(checkbox.value);
                } else {
                    selectedComments.delete(checkbox.value);
                }
            });
        }

        // ëŒ“ê¸€ ì„ íƒ í† ê¸€
        function toggleCommentSelection(commentId) {
            if (selectedComments.has(commentId)) {
                selectedComments.delete(commentId);
            } else {
                selectedComments.add(commentId);
            }
        }

        // ëŒ“ê¸€ ì†Œí”„íŠ¸ ì‚­ì œ
        async function deleteComment(commentId) {
            if (!confirm('ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì†Œí”„íŠ¸ ì‚­ì œ - ë³µêµ¬ ê°€ëŠ¥)')) {
                return;
            }

            try {
                await db.collection('comments').doc(commentId).update({
                    deleted: true,
                    deletedAt: Date.now(),
                    deletedBy: 'admin'
                });
                
                console.log('Comment soft deleted:', commentId);
            } catch (error) {
                console.error('Error deleting comment:', error);
                alert('ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ëŒ“ê¸€ ë³µêµ¬
        async function restoreComment(commentId) {
            if (!confirm('ì´ ëŒ“ê¸€ì„ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                await db.collection('comments').doc(commentId).update({
                    deleted: firebase.firestore.FieldValue.delete(),
                    deletedAt: firebase.firestore.FieldValue.delete(),
                    deletedBy: firebase.firestore.FieldValue.delete()
                });
                
                console.log('Comment restored:', commentId);
            } catch (error) {
                console.error('Error restoring comment:', error);
                alert('ëŒ“ê¸€ ë³µêµ¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì¼ê´„ ì‚­ì œ
        async function bulkDelete() {
            const activeSelected = Array.from(selectedComments).filter(id => {
                const comment = allComments.find(c => c.id === id);
                return comment && !comment.deleted;
            });

            if (activeSelected.length === 0) {
                alert('ì‚­ì œí•  ëŒ“ê¸€ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!confirm(`${activeSelected.length}ê°œì˜ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì†Œí”„íŠ¸ ì‚­ì œ - ë³µêµ¬ ê°€ëŠ¥)`)) {
                return;
            }

            try {
                const batch = db.batch();
                
                activeSelected.forEach(commentId => {
                    const docRef = db.collection('comments').doc(commentId);
                    batch.update(docRef, {
                        deleted: true,
                        deletedAt: Date.now(),
                        deletedBy: 'admin'
                    });
                });

                await batch.commit();
                
                selectedComments.clear();
                document.getElementById('select-all').checked = false;
                console.log('Bulk soft delete completed:', activeSelected.length);
                
            } catch (error) {
                console.error('Error bulk deleting comments:', error);
                alert('ì¼ê´„ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ìƒˆë¡œê³ ì¹¨
        function refreshComments() {
            selectedComments.clear();
            document.getElementById('select-all').checked = false;
            loadComments();
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'ì•Œ ìˆ˜ ì—†ìŒ';
            
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'ë°©ê¸ˆ';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}ë¶„ ì „`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}ì‹œê°„ ì „`;
            if (diff < 604800000) return `${Math.floor(diff / 86400000)}ì¼ ì „`;
            
            return date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }
    </script>
</body>
</html>
